# Yagami CI — Run all tests across all 4 services
name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── Python (Telegram Client) ──────────────────────────────
  python-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/telegram-client
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      - name: Run tests
        run: pytest tests/ -v --tb=short

  # ── Go (API Gateway) ──────────────────────────────────────
  go-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api-gateway
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      - name: Run tests
        run: go test ./... -v -race

  # ── Elixir (YouTube Poller) ────────────────────────────────
  elixir-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/youtube-poller
    steps:
      - uses: actions/checkout@v4
      - uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.16"
          otp-version: "26"
      - name: Install dependencies
        run: mix deps.get
      - name: Compile
        run: mix compile --warnings-as-errors
      - name: Run tests
        run: mix test --trace

  # ── Rust (Downloader) ─────────────────────────────────────
  rust-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/downloader
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.77"
      - name: Run tests
        run: cargo test --verbose

  # ── Integration (full pipeline) ────────────────────────────
  integration-tests:
    runs-on: ubuntu-latest
    needs: [python-tests, go-tests, elixir-tests, rust-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Start infrastructure
        run: |
          docker compose up -d postgres nats
          sleep 5

      - name: Install test dependencies
        run: pip install pytest pytest-asyncio nats-py asyncpg httpx

      - name: Run integration tests
        run: pytest tests/test_integration.py -v --tb=short
        env:
          NATS_URL: nats://localhost:4222
          DATABASE_URL: postgres://yagami:yagami@localhost:5432/yagami

      - name: Run workflow tests
        run: pytest tests/test_workflow.py -v --tb=short
        env:
          NATS_URL: nats://localhost:4222
          DATABASE_URL: postgres://yagami:yagami@localhost:5432/yagami

      - name: Cleanup
        if: always()
        run: docker compose down
